services:
  # ─── MySQL 8.0 ──────────────────────────────────────────────────────────────
  mysql:
    image: mysql:8.0.36
    container_name: jsmon-mysql
    restart: unless-stopped
    command: --default-storage-engine=InnoDB --innodb-autoinc-lock-mode=2 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --explicit_defaults_for_timestamp=ON --innodb-buffer-pool-size=128M --innodb-log-file-size=48M
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE:      ${MYSQL_DATABASE:-js_monitoring}
      MYSQL_USER:          ${MYSQL_USER:-jsmon}
      MYSQL_PASSWORD:      ${MYSQL_PASSWORD:-supersecretpassword}
      MYSQL_ROOT_HOST: "%"
      MYSQL_INITDB_SKIP_TZINFO: "yes"
      TZ: "UTC"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "127.0.0.1:3306:3306"   # только localhost (безопасность)
    healthcheck:
      test: ["CMD", "bash", "-c", "mysqladmin ping --user=root --password=$MYSQL_ROOT_PASSWORD 2>/dev/null | grep -q 'mysqld is alive'"]
      interval: 5s
      timeout: 10s
      start_period: 180s
      retries: 30
    networks:
      - jsmon-net

  # ─── Go Backend ─────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: jsmon-backend
    restart: unless-stopped
    environment:
      DB_HOST:     mysql
      DB_PORT:     3306
      DB_USER:     ${MYSQL_USER:-jsmon}
      DB_PASSWORD: ${MYSQL_PASSWORD:-supersecretpassword}
      DB_NAME:     ${MYSQL_DATABASE:-js_monitoring}
      PORT:        8080
      API_SECRET_KEY: ${API_SECRET_KEY:-change_me_in_production}
      JWT_SECRET:     ${JWT_SECRET:-change_me_jwt_secret_in_production}
      STEAM_API_KEY:  ${STEAM_API_KEY:-}
      APP_URL:        ${APP_URL:-http://localhost}
      TELEGRAM_BOT_TOKEN:      ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_DEFAULT_CHAT_ID: ${TELEGRAM_DEFAULT_CHAT_ID:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-mysql,localhost,127.0.0.1}
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/log/letsencrypt:/var/log/letsencrypt:ro
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/v1/stats"]
      interval: 15s
      timeout: 10s
      start_period: 45s
      retries: 5
    networks:
      - jsmon-net

  # ─── Next.js Frontend ───────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ""       # пустая строка → использует nginx rewrite
        NEXT_PUBLIC_WS_URL: ""
    container_name: jsmon-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: ""
      NEXT_PUBLIC_WS_URL: ""
    depends_on:
      backend:
        condition: service_started
    networks:
      - jsmon-net

  # ─── Nginx reverse-proxy ─────────────────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: jsmon-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/502.html:/usr/share/nginx/html/502.html:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      backend:
        condition: service_started
      frontend:
        condition: service_started
    networks:
      - jsmon-net

  # ─── Certbot (авторенью Let's Encrypt каждые 12 ч) ──────────────────────────
  certbot:
    image: certbot/certbot:latest
    container_name: jsmon-certbot
    restart: unless-stopped
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - /var/www/certbot:/var/www/certbot
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --quiet --webroot -w /var/www/certbot; sleep 12h & wait $$!; done"
    networks:
      - jsmon-net
    profiles:
      - ssl

volumes:
  mysql_data:
    driver: local

networks:
  jsmon-net:
    driver: bridge
